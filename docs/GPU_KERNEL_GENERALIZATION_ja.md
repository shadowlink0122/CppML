# GPUå®Ÿè£…ã®æ±ç”¨åŒ–è¨­è¨ˆ

## ğŸ¯ æ¦‚è¦

å¾“æ¥ã®GPUå®Ÿè£…ã§ã¯ã€å„activationé–¢æ•°ã”ã¨ã«åŒã˜ãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ãŒé‡è¤‡ã—ã¦ã„ã¾ã—ãŸã€‚æ–°ã—ã„æ±ç”¨çš„ãªè¨­è¨ˆã«ã‚ˆã‚Šã€ä¿å®ˆæ€§ã€æ‹¡å¼µæ€§ã€é–‹ç™ºåŠ¹ç‡ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã—ãŸã€‚

## ğŸ“‹ å¾“æ¥ã®å•é¡Œç‚¹

### âŒ **å•é¡Œç‚¹**
```cpp
// å¾“æ¥: å„é–¢æ•°ã§åŒã˜ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é‡è¤‡
void MetalBackend::relu(const double* input, double* output, size_t size) {
    // 100è¡Œä»¥ä¸Šã®åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚³ãƒ¼ãƒ‰
    // - doubleâ†’floatå¤‰æ›
    // - ãƒãƒƒãƒ•ã‚¡ä½œæˆ
    // - ã‚«ãƒ¼ãƒãƒ«æ–‡å­—åˆ—å®šç¾©  
    // - ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
    // - å®Ÿè¡Œ
    // - floatâ†’doubleå¤‰æ›
}

void MetalBackend::sigmoid(const double* input, double* output, size_t size) {
    // åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚³ãƒ¼ãƒ‰ï¼ˆ95%é‡è¤‡ï¼‰
    // ã‚«ãƒ¼ãƒãƒ«æ–‡å­—åˆ—ã ã‘ãŒé•ã†
}

void MetalBackend::tanh_activation(const double* input, double* output, size_t size) {
    // åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚³ãƒ¼ãƒ‰ï¼ˆ95%é‡è¤‡ï¼‰
    // ã‚«ãƒ¼ãƒãƒ«æ–‡å­—åˆ—ã ã‘ãŒé•ã†
}
```

### ğŸ”´ **ç¶­æŒç®¡ç†ã®èª²é¡Œ**
- æ–°ã—ã„activationé–¢æ•°è¿½åŠ æ™‚ã«100è¡Œä»¥ä¸Šã®ã‚³ãƒ”ãƒš
- ãƒã‚°ä¿®æ­£æ™‚ã«å…¨ã¦ã®é–¢æ•°ã‚’æ›´æ–°ã™ã‚‹å¿…è¦
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãé–¢æ•°ï¼ˆLeakyReLUç­‰ï¼‰ã®å®Ÿè£…ãŒå›°é›£
- Metalå›ºæœ‰ã®ã‚³ãƒ¼ãƒ‰ãŒactivationå±¤ã«æ•£åœ¨

## âœ… æ–°ã—ã„æ±ç”¨è¨­è¨ˆ

### ğŸ—ï¸ **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Application Layer             â”‚
â”‚  MetalBackend::relu(), sigmoid(), etc.  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ActivationKernelRegistry           â”‚
â”‚   â€¢ é–¢æ•°ç™»éŒ²ãƒ»å®Ÿè¡Œã®çµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹      â”‚
â”‚   â€¢ æ•°å¼ã‹ã‚‰ã‚«ãƒ¼ãƒãƒ«è‡ªå‹•ç”Ÿæˆ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       GPUKernelManager                  â”‚
â”‚   â€¢ æ±ç”¨ã‚«ãƒ¼ãƒãƒ«å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³               â”‚  
â”‚   â€¢ ãƒãƒƒãƒ•ã‚¡ç®¡ç†ã®çµ±ä¸€                   â”‚
â”‚   â€¢ Metal/CUDA/ROCmå¯¾å¿œ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¯ **æ ¸å¿ƒçš„ãªæ”¹å–„**

#### 1. **å®£è¨€çš„ãªé–¢æ•°å®šç¾©**
```cpp
// æ–°ã—ã„æ–¹æ³•: 1è¡Œã§é–¢æ•°å®šç¾©
ActivationKernelRegistry::registerActivation({
    "leaky_relu", 
    "input > 0.0f ? input : alpha * input",  // GPUå¼ã ã‘è¨˜è¿°
    {"alpha"},                               // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å
    true                                     // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ‰ç„¡
});
```

#### 2. **è‡ªå‹•ã‚«ãƒ¼ãƒãƒ«ç”Ÿæˆ**
```cpp
// å†…éƒ¨ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹Metal kernel
kernel void leaky_relu_kernel(device const float* input [[buffer(0)]],
                              device float* output [[buffer(1)]],
                              device const float* alpha [[buffer(2)]],
                              uint index [[thread_position_in_grid]]) {
    float alpha = alpha[0];
    output[index] = input > 0.0f ? input : alpha * input;
}
```

#### 3. **çµ±ä¸€ã•ã‚ŒãŸAPI**
```cpp
// ã™ã¹ã¦ã®é–¢æ•°ã§åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
MetalBackend::relu(input, output, size);                    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—
MetalBackend::leaky_relu(input, output, size, 0.01);        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚ã‚Š
MetalBackend::elu(input, output, size, 1.0);               // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚ã‚Š

// ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã‚‚åŒã˜API
ActivationKernelRegistry::executeActivation("custom_func", input, output, size, {param1, param2});
```

## ğŸš€ åˆ©ç”¨æ–¹æ³•

### æ–°ã—ã„Activationé–¢æ•°ã®è¿½åŠ 

#### **Step 1: é–¢æ•°ç™»éŒ²**
```cpp
ActivationKernelRegistry::registerActivation({
    "mish",                                      // é–¢æ•°å
    "input * tanh(log(1.0f + exp(input)))",     // GPUæ•°å¼
    {},                                          // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—
    false                                        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ãƒ©ã‚°
});
```

#### **Step 2: Backend APIã«è¿½åŠ **
```cpp
// metal_backend.hpp
static void mish(const double* input, double* output, size_t size);

// metal_backend.mm  
void MetalBackend::mish(const double* input, double* output, size_t size) {
    ActivationKernelRegistry::executeActivation("mish", input, output, size);
}
```

#### **Step 3: ä½¿ç”¨**
```cpp
// ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ä½¿ç”¨
MetalBackend::mish(input_data, output_data, size);
```

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãé–¢æ•°ã®ä¾‹

```cpp
// Swish-Beta (ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ã)
ActivationKernelRegistry::registerActivation({
    "swish_beta",
    "input / (1.0f + exp(-beta * input))",  // betaå€ã®Swish
    {"beta"},
    true
});

// ä½¿ç”¨
MetalBackend::swish_beta(input, output, size, 1.5);  // beta=1.5
```

## ğŸ“Š ãƒ¡ãƒªãƒƒãƒˆæ¯”è¼ƒ

| é …ç›® | å¾“æ¥ã®å®Ÿè£… | æ–°ã—ã„æ±ç”¨å®Ÿè£… |
|------|------------|----------------|
| **æ–°é–¢æ•°è¿½åŠ ** | 100+è¡Œã®ã‚³ãƒ”ãƒš | 1-3è¡Œã®å®šç¾© |
| **ä¿å®ˆæ€§** | å„é–¢æ•°ã‚’å€‹åˆ¥ä¿®æ­£ | ä¸­å¤®é›†ç´„ç®¡ç† |
| **ãƒã‚°ä¿®æ­£** | å…¨é–¢æ•°ã§ä¿®æ­£å¿…è¦ | ä¸€ç®‡æ‰€ã§ä¿®æ­£ |
| **ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œ** | æ‰‹å‹•å®Ÿè£… | è‡ªå‹•å¯¾å¿œ |
| **ã‚³ãƒ¼ãƒ‰é‡è¤‡** | 95%é‡è¤‡ | 0%é‡è¤‡ |
| **ãƒ†ã‚¹ãƒˆå·¥æ•°** | å„é–¢æ•°å€‹åˆ¥ãƒ†ã‚¹ãƒˆ | çµ±ä¸€ãƒ†ã‚¹ãƒˆ |

## ğŸ”§ å®Ÿè£…è©³ç´°

### GPUKernelManager
- **å½¹å‰²**: æ±ç”¨çš„ãªGPUã‚«ãƒ¼ãƒãƒ«å®Ÿè¡ŒåŸºç›¤
- **æ©Ÿèƒ½**: 
  - ãƒãƒƒãƒ•ã‚¡ç®¡ç†ã®çµ±ä¸€
  - doubleâ‡”floatå¤‰æ›ã®è‡ªå‹•åŒ–
  - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ¨™æº–åŒ–
  - Metal/CUDA/ROCmå¯¾å¿œã®æŠ½è±¡åŒ–

### ActivationKernelRegistry
- **å½¹å‰²**: Activationé–¢æ•°ã®ç®¡ç†ãƒ»å®Ÿè¡Œ
- **æ©Ÿèƒ½**:
  - æ•°å¼ã‹ã‚‰ã‚«ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ‰è‡ªå‹•ç”Ÿæˆ
  - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãé–¢æ•°ã®è‡ªå‹•å¯¾å¿œ
  - å‹å®‰å…¨ãªAPIæä¾›

### MetalBackend
- **å½¹å‰²**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘API
- **å¤‰æ›´**: é‡è¤‡ã‚³ãƒ¼ãƒ‰å‰Šé™¤ã€æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ä½¿ç”¨

## ğŸ¯ ä»Šå¾Œã®æ‹¡å¼µ

### 1. **ä»–ã®GPUãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å¯¾å¿œ**
```cpp
// CUDAç‰ˆã‚‚åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
CUDAKernelManager::executeUnaryKernel("relu", input, output, size);
```

### 2. **è¤‡åˆé–¢æ•°ã‚µãƒãƒ¼ãƒˆ**
```cpp
// è¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã®é–¢æ•°
registerActivation({
    "gelu_precise",
    "0.5f * input * (1.0f + erf(input / 1.4142135623f))",  // æ­£ç¢ºãªGELU
    {},
    false
});
```

### 3. **æœ€é©åŒ–ã‚«ãƒ¼ãƒãƒ«**
```cpp
// ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ç‰¹åŒ–æœ€é©åŒ–
registerOptimizedKernel("relu", "optimized_relu_metal.metal");
```

## ğŸ’¡ è¨­è¨ˆåŸå‰‡

1. **DRY (Don't Repeat Yourself)**: ã‚³ãƒ¼ãƒ‰é‡è¤‡ã®å®Œå…¨æ’é™¤
2. **å˜ä¸€è²¬ä»»åŸå‰‡**: å„ã‚¯ãƒ©ã‚¹ãŒæ˜ç¢ºãªå½¹å‰²ã‚’æŒã¤
3. **æ‹¡å¼µæ€§**: æ–°æ©Ÿèƒ½è¿½åŠ ãŒå®¹æ˜“
4. **å‹å®‰å…¨æ€§**: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã‚¨ãƒ©ãƒ¼æ¤œå‡º
5. **æ€§èƒ½**: ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰æœ€å°åŒ–

## ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### çµ±ä¸€ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
```cpp
template<typename ActivationFunc>
void test_activation_gpu(const std::string& name, ActivationFunc cpu_func) {
    // GPU vs CPUæ¯”è¼ƒãƒ†ã‚¹ãƒˆ
    // æ•°å€¤ç²¾åº¦ãƒ†ã‚¹ãƒˆ
    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
}

// ä½¿ç”¨ä¾‹
test_activation_gpu("relu", [](double x) { return std::max(0.0, x); });
test_activation_gpu("sigmoid", [](double x) { return 1.0 / (1.0 + std::exp(-x)); });
```

ã“ã®æ±ç”¨åŒ–ã«ã‚ˆã‚Šã€MLLibã®GPUå®Ÿè£…ã¯æ ¼æ®µã«ä¿å®ˆã—ã‚„ã™ãã€æ‹¡å¼µã—ã‚„ã™ããªã‚Šã¾ã—ãŸï¼
